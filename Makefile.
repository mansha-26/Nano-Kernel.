ASM = nasm
BOOT_SOURCE = boot/boot.asm
KERNEL_SOURCE = src/kernel.asm
OS_IMAGE = mini-os.img

all: $(OS_IMAGE)

$(OS_IMAGE): boot.bin kernel.bin
	# Create blank floppy image
	dd if=/dev/zero of=$(OS_IMAGE) bs=512 count=2880 status=none
	# Write bootloader to first sector
	dd if=boot.bin of=$(OS_IMAGE) conv=notrunc status=none
	# Write kernel starting from second sector
	dd if=kernel.bin of=$(OS_IMAGE) bs=512 seek=1 conv=notrunc status=none
	@echo "âœ… OS image created: $(OS_IMAGE)"
	@echo "ðŸ“Š Boot sector: $$(stat -c%s boot.bin) bytes"
	@echo "ðŸ“Š Kernel: $$(stat -c%s kernel.bin) bytes"

boot.bin: $(BOOT_SOURCE)
	$(ASM) -f bin $< -o $@
	@echo "ðŸ”§ Built bootloader"

kernel.bin: $(KERNEL_SOURCE)
	$(ASM) -f bin $< -o $@
	@echo "ðŸ”§ Built kernel"

run: $(OS_IMAGE)
	@echo "ðŸš€ Starting QEMU..."
	qemu-system-x86_64 -fda $(OS_IMAGE)

clean:
	rm -f boot.bin kernel.bin $(OS_IMAGE)
	@echo "ðŸ§¹ Cleaned build files"

verify:
	@echo "ðŸ” Verifying boot sector..."
	hexdump -C boot.bin | tail -2
	@echo "ðŸ” Kernel size: $$(stat -c%s kernel.bin) bytes"
